<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>취미 게시글</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #searchTitle {
            border: 2px solid #007bff; /* 파란색 테두리 */
            border-radius: 20px; /* 둥근 모양 */
            padding: 8px 15px;
            outline: none;
            margin-right: 5px;
        }

        .btn-outline-primary {
            border-radius: 10px; /* 버튼도 둥글게 */
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">취미 게시글</h2>
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-secondary" th:if="${isLoggedIn}" onclick="logout()">로그아웃</button>
        <button class="btn btn-primary ms-2" th:if="${isLoggedIn}" th:onclick="|location.href='@{/post/write}'|" type="button">글 작성하기</button>
        <button class="btn btn-success ms-2" th:if="${!isLoggedIn}" th:onclick="|location.href='@{/login}'|" type="button">로그인</button>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <form id="searchForm" class="d-flex">
            <input type="text" id="searchTitle"  placeholder="제목 검색">
            <button type="submit" class="btn btn-outline-primary">검색</button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>제목</th>
                <th>작성자</th>
                <th>작성일</th>
                <th>조회수</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="post : ${posts}" th:action="@{/post/{postId}(postId=${post.postId})}" class="get">
                <td th:text="${post.postId}"></td>
                <td>
                    <a th:href="@{/post/{postId}(postId=${post.postId})}"
                       th:onclick="'incrementViewCount('+${post.postId}+');'"
                       th:text="${#strings.length(post.title) > 10 ? post.title.substring(0, 10) + '...' : post.title}">
                    </a>
                </td>
                <td th:text="${post.name}"></td>
                <td>
                    <span th:if="${post.createdDate.substring(0,10).equals(#dates.format(#dates.createNow(), 'yyyy.MM.dd'))}"
                          th:text="${post.createdDate.substring(11,16)}"></span>
                    <span th:if="${!post.createdDate.substring(0,10).equals(#dates.format(#dates.createNow(), 'yyyy.MM.dd'))}"
                          th:text="${post.createdDate.substring(2,10)}"></span>
                </td>
                <td id="view-count-[[${post.postId}]]" th:text="${post.count}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-center mt-3">
        <nav>
            <ul class="pagination" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 10;
    let currentSearchTitle = "";

    document.getElementById('searchForm').addEventListener('submit', function(event) {
        event.preventDefault(); // 기본 폼 제출 방지
        currentSearchTitle = document.getElementById('searchTitle').value; // 검색어 저장
        loadPosts(1); // 첫 페이지에서 검색 실행
    });

    function loadPosts(page) {
        let url = `/posts?page=${page}&size=${pageSize}`;
        if (currentSearchTitle) {
            url += `&searchTitle=${encodeURIComponent(currentSearchTitle)}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const postList = document.querySelector('tbody');
                postList.innerHTML = '';

                data.posts.forEach(post => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${post.postId}</td>
                    <td><a href="/post/${post.postId}">${post.title}</a></td>
                    <td>${post.name}</td>
                    <td>${formatDate(post.createdDate)}</td>
                    <td>${post.count}</td>
                `;
                    postList.appendChild(row);
                });

                updatePagination(page, Math.ceil(data.totalPostCount / pageSize));
                currentPage = page;
            })
            .catch(error => console.error('Error fetching posts:', error));
    }


    function updatePagination(current, totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        const maxPagesToShow = 5;
        let startPage = Math.max(1, current - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage < maxPagesToShow - 1) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === current ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="loadPosts(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
    }

    // 페이지 로드 시 첫 페이지 불러오기
    loadPosts(1);

    function logout() {
        fetch('/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        }).then(response => {
            if (response.ok) {
                window.location.href = '/post';
            } else {
                return response.json().then(data => {
                    alert("에러: " + data.map(error => error.defaultMessage).join("\n"));
                });
            }
        }).catch(error => {
            console.error("Error:", error);
            alert("로그아웃 중 오류가 발생했습니다.");
        });
    }
    function incrementViewCount(postId) {
        fetch(`/post/${postId}/count`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    // 현재 조회수를 +1 증가시키기
                    const viewCountElement = document.getElementById(`view-count-${postId}`);
                    if (viewCountElement) {
                        viewCountElement.innerText = parseInt(viewCountElement.innerText) + 1;
                    }
                }
            })
            .catch(error => console.error('조회수 업데이트 오류:', error));
    }

    function formatDate(createdDate) {
        const today = new Date().toISOString().slice(0, 10); // 오늘 날짜 'yyyy-MM-dd'
        const datePart = createdDate.substring(0, 10); // 'yyyy-MM-dd'

        if (datePart === today) {
            return createdDate.substring(11, 16); // 오늘이면 'HH:mm'만 표시
        } else {
            return datePart; // 과거면 'yyyy-MM-dd' 그대로 표시
        }
    }

</script>
</body>
</html>
