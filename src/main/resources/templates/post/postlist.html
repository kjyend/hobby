<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì·¨ë¯¸ ê²Œì‹œê¸€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ --- */
        #searchTitle {
            border: 2px solid #007bff;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
            margin-right: 5px;
        }
        .btn-outline-primary {
            border-radius: 10px;
        }
        /* --- ì•Œë¦¼ ì•„ì´ì½˜ í”ë“¤ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        #notification-icon.shake {
            animation: shake 0.5s ease-in-out;
        }
        #notification-icon {
            position: relative;
            display: inline-block;
            font-size: 24px;
            cursor: pointer;
        }
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 50%;
            display: none;
        }
        /* --- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ --- */
        #notification-dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            width: 200px;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            display: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <!-- ì œëª© -->
    <h2 class="text-center mb-4">ì·¨ë¯¸ ê²Œì‹œê¸€</h2>

    <!-- ì•Œë¦¼ ì•„ì´ì½˜ ë° ë°°ì§€ -->
    <div id="notification-container" style="display: none;">
        <div id="notification-icon">
            <span class="icon">ğŸ””</span>
            <span id="notification-badge" class="badge">0</span>
        </div>
        <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
        <div id="notification-dropdown" class="hidden">
            <ul id="notification-list"></ul>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸/ê¸€ì‘ì„±/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div class="d-flex justify-content-end mb-3" id="button-container" style="display: none;">
        <button id="logout-btn" class="btn btn-outline-secondary" style="display: none;"
                onclick="logout()" type="button">ë¡œê·¸ì•„ì›ƒ</button>
        <button id="write-btn" class="btn btn-primary ms-2" style="display: none;"
                onclick="checkAndRedirectToWrite()" type="button">ê¸€ ì‘ì„±í•˜ê¸°
            <input type="hidden" id="Authorization" name="Authorization">
        </button>
        <button id="login-btn" class="btn btn-success ms-2" style="display: none;"
                onclick="location.href='/login'" type="button">ë¡œê·¸ì¸</button>
    </div>
    <!-- ê²€ìƒ‰ í¼ -->
    <div class="d-flex justify-content-end mb-3">
        <form id="searchForm" class="d-flex">
            <input type="text" id="searchTitle" placeholder="ì œëª© ê²€ìƒ‰">
            <button type="submit" class="btn btn-outline-primary">ê²€ìƒ‰</button>
        </form>
    </div>

    <!-- ê²Œì‹œë¬¼ í…Œì´ë¸” -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>ì œëª©</th>
                <th>ì‘ì„±ì</th>
                <th>ì‘ì„±ì¼</th>
                <th>ì¡°íšŒìˆ˜</th>
            </tr>
            </thead>
            <tbody>
            <!-- ê²Œì‹œë¬¼ì€ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </tbody>
        </table>
    </div>

    <!-- í˜ì´ì§• ì˜ì—­ -->
    <div class="d-flex justify-content-center mt-3">
        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
<script th:inline="javascript">


    document.addEventListener("DOMContentLoaded", function () {

        async function checkLoginStatus() {
            const token = localStorage.getItem("accessToken");
            const buttonContainer = document.getElementById("button-container");
            const loginBtn = document.getElementById("login-btn");
            const logoutBtn = document.getElementById("logout-btn");
            const writeBtn = document.getElementById("write-btn");
            const notifiContainer = document.getElementById("notification-container");

            if (!token) {
                loginBtn.style.display = "block";
                buttonContainer.style.display = "block";
                return;
            }

            try {
                const response = await fetch('/login/user/info', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const data = await response.json();
                if (data.isLoggedIn && data.userId) {
                    logoutBtn.style.display = "block";
                    writeBtn.style.display = "block";
                    notifiContainer.style.display = "block";
                    connectSSE(data.userId);
                } else {
                    loginBtn.style.display = "block";
                }
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                loginBtn.style.display = "block";
            } finally {
                buttonContainer.style.display = "block";
            }
        }

        checkLoginStatus();

        window.checkAndRedirectToWrite = function ()  {
            const token = localStorage.getItem("accessToken");

            if (!token) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "/login";
                return;
            }

            window.location.href = "/post/write";
        }
        // ===========================
        // 1) SSE ì•Œë¦¼ ê´€ë ¨ ì½”ë“œ
        // ===========================
        const icon = document.getElementById("notification-icon");
        const badge = document.getElementById("notification-badge");
        const dropdown = document.getElementById("notification-dropdown");
        const notificationList = document.getElementById("notification-list");

        function showNotification(message) {
            badge.style.display = "inline-block";
            badge.textContent = parseInt(badge.textContent || 0) + 1;
            const newItem = document.createElement("li");
            newItem.textContent = message;
            notificationList.prepend(newItem);
            icon.classList.add("shake");
            icon.addEventListener("animationend", () => {
                icon.classList.remove("shake");
            }, { once: true });
            dropdown.classList.remove("hidden");
        }

        function toggleNotifications() {
            if (dropdown.classList.contains("hidden")) {
                // 1ï¸âƒ£ ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ì„ ë³´ì—¬ì¤Œ
                dropdown.classList.remove("hidden");

                // 2ï¸âƒ£ ìˆ«ì ì´ˆê¸°í™” (ë±ƒì§€ ìˆ¨ê¹€)
                badge.textContent = "";
                badge.style.display = "none";
            } else {
                dropdown.classList.add("hidden");
            }
        }
        icon.addEventListener("click", toggleNotifications);

        let eventSource;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5; // ìµœëŒ€ 5ë²ˆê¹Œì§€ ì¬ì—°ê²° ì‹œë„
        const reconnectInterval = 3000;

        function connectSSE(userId) {
            if (!userId) return;

            eventSource = new EventSource(`/notifications/subscribe/${userId}`);

            eventSource.addEventListener("notification", function (event) {
                showNotification(event.data);
                reconnectAttempts = 0; // ì•Œë¦¼ì„ ì •ìƒì ìœ¼ë¡œ ë°›ìœ¼ë©´ ì¬ì—°ê²° íšŸìˆ˜ ì´ˆê¸°í™”
            });

            eventSource.onerror = function () {
                console.error("SSE ì—°ê²° ëŠì–´ì§. ì¬ì—°ê²° ì‹œë„ ì¤‘...");
                eventSource.close();

                reconnectAttempts++;
                if (reconnectAttempts <= maxReconnectAttempts) {
                    setTimeout(connectSSE, reconnectInterval);
                } else {
                    console.error("SSE ì¬ì—°ê²° íšŸìˆ˜ ì´ˆê³¼. ì¤‘ë‹¨.");
                }
            };
        }


        // =================================
        // 2) ê²Œì‹œê¸€ ê²€ìƒ‰ & í˜ì´ì§• ê¸°ëŠ¥
        // =================================
        let currentPage = 1;
        const pageSize = 10;
        let currentSearchTitle = "";

        document.getElementById('searchForm').addEventListener('submit', function (event) {
            event.preventDefault();
            currentSearchTitle = document.getElementById('searchTitle').value;
            loadPosts(1);
        });

        // ê²Œì‹œë¬¼ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        function loadPosts(page) {
            fetch(`/posts?page=${page}&size=${pageSize}`)
                .then(response => response.json())
                .then(data => {
                    console.log("ë°›ì€ ë°ì´í„°:", data);
                    const postList = document.querySelector('tbody');
                    postList.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

                    data.posts.forEach(post => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${post.postId}</td>
                            <td><a href="#" data-id="${post.postId}">${post.title}</a></td>
                            <td>${post.name}</td>
                            <td>${formatDate(post.createdDate)}</td>
                            <td>${post.count}</td>
                        `;
                        postList.appendChild(row);
                    });
                    const totalPages = Math.ceil(data.totalPostCount / pageSize);
                    updatePagination(page, totalPages);
                    currentPage = page;
                })
                .catch(error => console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', error));
        }

        // ê²Œì‹œê¸€ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener("click", function (event) {
            if (event.target.matches("td a")) {
                event.preventDefault();

                const postId = event.target.getAttribute("data-id");
                const token = localStorage.getItem("accessToken");

                if (!token) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "/login";
                    return;
                }

                increaseViewCount(postId, token);
            }
        });
        // ì¡°íšŒìˆ˜ ì¦ê°€ í•¨ìˆ˜
        function increaseViewCount(postId, token) {
            fetch(`/post/${postId}/count`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤íŒ¨");
                    }
                })
                .then(() => {
                    moveToPostPage(postId); // ì¡°íšŒìˆ˜ ì¦ê°€ ì„±ê³µ ì‹œ ì´ë™
                })
                .catch(error => {
                    console.error('ì¡°íšŒìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error);
                    alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
        }

        // í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        function moveToPostPage(postId) {
            window.location.href = `post/${postId}`;

        }

        // í˜ì´ì§• ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePagination(current, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (totalPages < 1) {
                return;
            }

            const maxPagesToShow = 10;
            let pageRangeStart = Math.floor((current - 1) / maxPagesToShow) * maxPagesToShow + 1;
            let pageRangeEnd = Math.min(pageRangeStart + maxPagesToShow - 1, totalPages);

            for (let i = pageRangeStart; i <= pageRangeEnd; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === current ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    loadPosts(i);
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDate(createdDate) {
            const today = new Date().toISOString().substring(0, 10);
            const datePart = createdDate.substring(0, 10);
            return datePart === today ? createdDate.substring(11, 16) : datePart;
        }

        // ì´ˆê¸° ê²Œì‹œê¸€ ë¡œë“œ
        loadPosts(1);
    });

    function logout() {
        localStorage.removeItem("accessToken");
        location.reload();
    }
</script>

</body>
</html>
