<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>글 보기</title>
</head>
<body>
<div style="text-align: center; margin-top: 100px;">
    <!-- 게시글 제목과 내용 -->
    <div>
        <h2 th:text="${post.title}" id="title" name="title">제목</h2>
        <p th:text="${post.content}" id="content" name="content">내용</p>
    </div>

    <!-- 수정하기 버튼 -->
    <div style="margin-top: 20px;">
        <button th:if="${isLoggedIn}" onclick="location.href='postedit.html'"
                th:onclick="|location.href='@{/post/edit/}' + ${postId}|"
                type="button">수정하기</button>
    </div>

    <!-- 게시글 삭제 -->
    <div style="margin-top: 10px;">
        <button th:if="${isLoggedIn}" type="button" th:onclick="'deletePost(' + ${postId} + ');'">글 삭제</button>
    </div>

    <!-- 댓글 리스트 -->
    <div id="comment-list" style="margin-top: 50px;">
        <h3>댓글</h3>
        <!-- JavaScript로 댓글 리스트를 표시할 공간 -->
    </div>

    <!-- 댓글 작성 폼 -->
    <div style="margin-top: 20px;">
        <textarea id="comment-content" placeholder="댓글을 입력하세요"></textarea><br>
        <button type="button" th:onclick="'addComment(' + ${postId} + ');'">댓글 작성</button>
    </div>

    <!-- 홈 버튼 -->
    <div style="margin-top: 10px;">
        <button type="button" onclick="location.href='home.html'"
                th:onclick="|location.href='@{/}'|">홈 화면으로</button>
    </div>
</div>

<script>
    // 댓글 리스트 불러오기
    function loadComments(postId) {
        fetch(`/post/${postId}/comment`)
            .then(response => response.json())
            .then(data => {
                const commentList = document.getElementById('comment-list');
                commentList.innerHTML = '';  // 기존 댓글 삭제

                data.forEach(comment => {
                    const commentElement = document.createElement('div');

                    // 댓글이 삭제 상태인지 확인하여 처리
                    if (comment.isDeleted === 'YES') {
                        commentElement.innerHTML = `
                        <p><em>삭제된 댓글입니다.</em></p>
                    `;
                    } else {
                        commentElement.innerHTML = `
                        <p>${comment.name}: ${comment.content}</p>
                        <button onclick="deleteComment(${postId}, ${comment.id})">댓글 삭제</button>
                    `;
                    }

                    commentList.appendChild(commentElement);
                });
            })
            .catch(error => {
                console.error('댓글을 불러오는 중 오류가 발생했습니다:', error);
            });
    }

    // 댓글 작성하기
    function addComment(postId) {
        const content = document.getElementById('comment-content').value;
        const commentData = { content: content };

        fetch(`/post/${postId}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(commentData),
        })
            .then(response => {
                if (response.ok) {
                    alert('댓글이 작성되었습니다.');
                    loadComments(postId);  // 댓글 리스트 갱신
                    document.getElementById('comment-content').value = '';  // 입력 필드 초기화
                } else {
                    alert('댓글 작성에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('댓글 작성 중 오류가 발생했습니다:', error);
            });
    }

    // 댓글 삭제하기
    function deleteComment(postId, commentId) {
        fetch(`/post/${postId}/comment/${commentId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    alert('댓글이 삭제되었습니다.');
                    loadComments(postId);  // 댓글 리스트 갱신
                } else {
                    alert('댓글 삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('댓글 삭제 중 오류가 발생했습니다:', error);
            });
    }

    // 게시글 삭제하기
    function deletePost(postId) {
        fetch(`/post/${postId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    alert('게시글이 삭제되었습니다.');
                    window.location.href = '/post';  // 게시글 리스트 페이지로 이동
                } else {
                    alert('게시글 삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('게시글 삭제 중 오류가 발생했습니다:', error);
            });
    }

    // 페이지 로딩 시 댓글 리스트 불러오기
    document.addEventListener('DOMContentLoaded', function () {
        const postId = [[${postId}]]; /* 게시글 ID를 서버에서 설정해야 합니다 */;
        loadComments(postId);
    });
</script>

</body>
</html>