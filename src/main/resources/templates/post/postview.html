<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Post View</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <div class="mt-3">
        <button class="btn btn-secondary" type="button"
                onclick="location.href='home.html'"
                th:onclick="|location.href='@{/post}'|">í™ˆ í™”ë©´ìœ¼ë¡œ</button>
    </div>

    <h2 th:text="${post.title}">ì œëª©</h2>
    ì‘ì„±ì: <span th:text="${post.name}">ì‘ì„±ì</span>
    <p th:text="${post.content}">ë‚´ìš©</p>


    <div class="image-container mt-4" th:if="${#lists.size(post.imageUrls) > 0}">
        <h4>Images:</h4>
        <div class="d-flex">
            <div th:each="imageUrl : ${post.imageUrls}">
                <img th:src="|/images/${imageUrl}|" class="img-thumbnail" style="max-width: 200px; margin-right: 10px;" alt="Image"/>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button id="edit-btn" class="btn btn-primary" th:onclick="'editPost(' + ${post.id} + ');'">ìˆ˜ì •í•˜ê¸°</button>
        <button id="delete-btn" class="btn btn-danger" th:onclick="'deletePost('+${post.id}+')'">ì‚­ì œí•˜ê¸°</button>
    </div>

    <div class="like-container mt-4">
        <button id="like-button" class="btn btn-outline-primary">
            ì¢‹ì•„ìš” <span id="like-count" th:text="${post.likeCount}"/>
        </button>
    </div>

    <h3>ëŒ“ê¸€</h3>

    <div class="comment-container mt-4">
        <textarea id="comment-content" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" rows="3"></textarea>
        <button class="btn btn-success mt-2" type="button"
                th:onclick="'addComment(' + ${post.id} + ');'">ëŒ“ê¸€ ì‘ì„±</button>
    </div>

    <div id="comment-list" class="mt-5"></div>

</div>

<script th:inline="javascript">
    const token = localStorage.getItem("accessToken");
    let currentUserLoginId = [[${#authentication.name}]];  // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì

    let liked = false;
    let isProcessing = false;

    async function checkLoginStatus(postId) {
        const token = localStorage.getItem("accessToken");
        const editBtn = document.getElementById("edit-btn");
        const deleteBtn = document.getElementById("delete-btn");

        if (!token) {
            editBtn.style.display = "none";
            deleteBtn.style.display = "none";
            return;
        }

        try {
            const response = await fetch(`/login/user/check?postId=${postId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            const data = await response.json();
            console.log("ì„œë²„ ì‘ë‹µ:", data); // ì‘ë‹µ ë°ì´í„° í™•ì¸

            if (data.isLoggedIn) {
                currentUserLoginId = data.userId; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ì„¤ì •
                if (data.isPostOwner) {
                    editBtn.style.display = "block";
                    deleteBtn.style.display = "block";
                    loadComments(postId)
                } else {
                    editBtn.style.display = "none";
                    deleteBtn.style.display = "none";
                }
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const postId = [[${post.id}]];
        checkLoginStatus(postId);
    });


    function loadComments(postId) {
        fetch(`/post/${postId}/comment`)
            .then(response => response.json())
            .then(data => {
                const commentList = document.getElementById('comment-list');
                commentList.innerHTML = '';  // ê¸°ì¡´ ëŒ“ê¸€ ì‚­ì œ

                data.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('border', 'p-2', 'mb-2', 'rounded', 'comment-container');
                    console.log("ëŒ“ê¸€ ID:", comment.id, "ì‘ì„±ì:", comment.name);  // ì½˜ì†” í™•ì¸


                    if (comment.isDeleted === 'YES') {
                        commentElement.innerHTML = `<p><em>ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</em></p>`;
                    } else {
                        commentElement.innerHTML = `<p>${comment.name}: ${comment.content}</p>`;

                        if (comment.loginId === currentUserLoginId) {
                            commentElement.innerHTML += `
                            <button class="btn btn-danger btn-sm" onclick="deleteComment(${postId}, ${comment.id})">ëŒ“ê¸€ ì‚­ì œ</button>
                        `;
                        }
                    }

                    commentList.appendChild(commentElement);
                });
            })
            .catch(error => {
                console.error('ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
            });
    }

    async function addComment(postId) {
        const content = document.getElementById('comment-content').value;
        if (!content.trim()) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }
        const commentData = { content: content };

        fetch(`/post/${postId}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(commentData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadComments(postId);
                    document.getElementById('comment-content').value = '';

                    // ğŸ”” ëŒ“ê¸€ ì‘ì„± ì‹œ ê²Œì‹œê¸€ ì‘ì„±ìì—ê²Œ ì•Œë¦¼ ì „ì†¡
                    sendNotification(postId, data.content ,data.postOwnerId);
                } else {
                    alert("ì—ëŸ¬: " + data.errors.join("\n"));
                }
            })
            .catch(error => {
                console.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
            });
    }
    // ğŸ“© ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
    function sendNotification(postId,message, postOwnerId) {
        const notificationData = {
            postId: postId,
            userId: postOwnerId,  // ê²Œì‹œê¸€ ì‘ì„±ìì˜ ID
            message: `ìƒˆë¡œìš´ ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! "${message}"`
        };
        console.log("sendNotification postOwnerId:", postOwnerId);

        fetch("http://localhost:8080/notifications/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(notificationData)
        })
            .then(response => response.text())
            .then(data => console.log("ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", data))
            .catch(error => console.error("ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:", error));
    }


    window.editPost = function (postId) {
        const token = localStorage.getItem("accessToken");

        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/login";
            return;
        }

        console.log(`ê²Œì‹œê¸€ ìˆ˜ì • í˜ì´ì§€ ì´ë™: /post/edit/${postId}`);
        window.location.href = `/post/edit/${postId}`;
    };

    function deleteComment(postId, commentId) {
        fetch(`/post/${postId}/comment/${commentId}`, {
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + token }
        })
            .then(response => {
                if (response.ok) {
                    alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadComments(postId);
                } else {
                    return response.json().then(data => {
                        alert("ì—ëŸ¬: " + data.map(error => error.defaultMessage).join("\n"));
                    });
                }
            })
            .catch(error => {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
            });
    }

    window.deletePost=function (postId) {
        fetch(`/post/${postId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(response => {
                if (response.ok) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/post';
                } else {
                    return response.json().then(data => {
                        alert("ì—ëŸ¬: " + data.map(error => error.defaultMessage).join("\n"));
                    });
                }
            })
            .catch(error => {
                console.error('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const postId = [[${post.id}]];

        loadComments(postId);

        fetch(`/post/${postId}/like/status`)
            .then(response => response.json())
            .then(data => {
                liked = data.liked;
                updateLikeUI(postId);
            });

        document.getElementById('like-button').addEventListener('click', function (event) {
            event.stopPropagation();  // ë¶€ëª¨ ìš”ì†Œë¡œ ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ë§‰ìŒ
            toggleLike(postId);
        });
    });

    function toggleLike(postId) {
        if (isProcessing) return;
        isProcessing = true;

        const url = liked ? `/post/${postId}/like/cancel` : `/post/${postId}/like`;
        const method = 'POST';

        fetch(url, { method , headers: { 'Authorization': 'Bearer ' + token } })
            .then(response => {
                if (response.ok) {
                    liked = !liked;
                    updateLikeUI(postId);
                } else {
                    alert('ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => console.error('ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error))
            .finally(() => {
                isProcessing = false;
            });
    }


    function updateLikeUI(postId) {
        const likeButton = document.getElementById('like-button');
        const likeCountElement = likeButton.querySelector('span');

        fetch(`/post/${postId}/like/count`,{method: 'GET',headers: { 'Authorization': 'Bearer ' + token }})
            .then(response => response.json())
            .then(data => {
                likeCountElement.textContent = data.count;  // span íƒœê·¸ ë‚´ë¶€ ê°’ë§Œ ë³€ê²½
            });

        if (liked) {
            likeButton.classList.remove('btn-outline-primary');
            likeButton.classList.add('btn-primary');
        } else {
            likeButton.classList.remove('btn-primary');
            likeButton.classList.add('btn-outline-primary');
        }
    }
</script>

</body>
</html>
